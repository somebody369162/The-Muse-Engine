<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Collaborative Muse Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Lora:ital,wght@0,400;0,700;1,400&family=Fira+Code:wght@500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #D1D5DB; }
        h1, h2, h3 { font-family: 'Lora', serif; }
        .word-card { transition: all 0.2s ease-in-out; }
        .word-card:hover { transform: translateY(-2px); background-color: #374151; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        code, .code-card { font-family: 'Fira Code', monospace; font-size: 0.9em; }
        .code-card:hover { background-color: #4B5563; }
        .loader { width: 48px; height: 48px; border: 3px solid #4B5563; border-bottom-color: #818CF8; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tooltip-container { position: relative; display: inline-block; }
        .tooltip-container .tooltip-text { visibility: hidden; width: 220px; background-color: #1F2937; color: #fff; text-align: left; border-radius: 6px; padding: 8px 12px; position: absolute; z-index: 50; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 0.8rem; line-height: 1.4; box-shadow: 0 2px 8px rgba(0,0,0,0.5); pointer-events: none; }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
        .has-tooltip { text-decoration: underline; text-decoration-style: dotted; text-decoration-color: #9CA3AF; text-underline-offset: 3px; }
        .accordion-panel { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out, margin-top 0.5s ease-in-out; }
        .accordion-panel.active { max-height: 500px; margin-top: 1rem; }
        .focus-btn { background-color: #374151; color: #D1D5DB; padding: 0.5rem 1rem; border-radius: 9999px; font-weight: 500; font-size: 0.875rem; transition: all 0.2s ease-in-out; border: 1px solid transparent; }
        .focus-btn:hover { background-color: #4B5563; }
        .focus-btn.active { color: #E0E7FF; background-color: #4338CA; box-shadow: 0 0 0 2px #111827, 0 0 0 4px #4F46E5; }
    </style>
</head>
<body class="antialiased">
    <div class="min-h-screen flex flex-col items-center p-4">
        <div class="w-full max-w-3xl mx-auto">
            <header class="text-center mb-8">
                <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">The Collaborative Muse Engine</h1>
                <p class="text-lg text-gray-400">Your companion for shared creative and technical exploration.</p>
            </header>
            <div class="relative mb-4">
                <input type="text" id="word-input" class="w-full pl-5 pr-48 py-4 text-lg bg-gray-800 border-2 border-gray-700 rounded-full focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 outline-none transition-colors text-white" placeholder="Enter a word...">
                <div class="absolute right-2 top-1/2 -translate-y-1/2 flex items-center gap-2">
                    <button id="flash-button" title="Due at 11:59pm Mode" class="bg-yellow-500 hover:bg-yellow-600 text-yellow-900 font-bold p-3 rounded-full transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-lightning-fill" viewBox="0 0 16 16"><path d="M5.52.359A.5.5 0 0 1 6 0h4a.5.5 0 0 1 .474.658L8.694 6H12.5a.5.5 0 0 1 .395.807l-7 9a.5.5 0 0 1-.873-.454L6.823 9.5H3.5a.5.5 0 0 1-.48-.641l2.5-8.5z"/></svg>
                    </button>
                    <button id="muse-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-full transition-colors">Evoke</button>
                </div>
            </div>
            <div id="focus-container" class="flex flex-wrap items-center justify-center gap-2 mb-8">
                <button data-focus="creative" class="focus-btn active">Creative</button>
                <button data-focus="technical" class="focus-btn">Technical</button>
                <button data-focus="scientific" class="focus-btn">Scientific</button>
                <button data-focus="psychology" class="focus-btn">Psychology</button>
                <button data-focus="legal" class="focus-btn">Legal</button>
                <button data-focus="medical" class="focus-btn">Medical</button>
            </div>

            <!-- Container for shared inspirations -->
            <div id="history-container" class="mb-8"></div>

            <div id="results-container" class="space-y-6">
                <div id="welcome-message" class="text-center text-gray-500 py-10"><p>Enter a word and let inspiration find you.</p></div>
            </div>
             <div id="generative-container" class="mt-8"></div>
        </div>
    </div>
    <div id="copy-notification" class="fixed bottom-5 right-5 bg-green-600 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 transition-all duration-300">Copied!</div>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
        // --- DOM Elements ---
        const wordInput = document.getElementById('word-input');
        const museButton = document.getElementById('muse-button');
        const flashButton = document.getElementById('flash-button');
        const resultsContainer = document.getElementById('results-container');
        const copyNotification = document.getElementById('copy-notification');
        const focusContainer = document.getElementById('focus-container');
        const generativeContainer = document.getElementById('generative-container');
        const historyContainer = document.getElementById('history-container');

        // --- State & Config ---
        let loadingInterval;
        let activeFocuses = new Set(['creative']);
        let currentResultsData = {};
        const loadingMessages = ["Consulting the muses...", "Checking the poetic archives...", "Translating concepts to code...", "Aligning constellations of thought...", "Almost there..."];
        
        // --- Environment Variables (Provided by the platform) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const apiKey = ""; // The platform provides the API key directly in fetch calls.

        // --- Firebase State ---
        let db, auth, userId, musesCollection;

        // --- App Initialization ---
        initializeAppAndAuth();

        // --- Event Listeners ---
        museButton.addEventListener('click', () => fetchMuseData(false));
        flashButton.addEventListener('click', () => fetchMuseData(true));
        wordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.shiftKey ? fetchMuseData(true) : fetchMuseData(false);
            }
        });

        focusContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('focus-btn')) {
                const focus = e.target.dataset.focus;
                if (activeFocuses.has(focus)) {
                    if (activeFocuses.size > 1) { 
                        activeFocuses.delete(focus);
                        e.target.classList.remove('active');
                    }
                } else {
                    activeFocuses.add(focus);
                    e.target.classList.add('active');
                }
            }
        });

        historyContainer.addEventListener('click', (e) => {
            let target = e.target.closest('.history-item');
            if (target) {
                const word = target.dataset.word;
                const data = JSON.parse(target.dataset.musedata);
                wordInput.value = word;
                resultsContainer.innerHTML = '';
                generativeContainer.innerHTML = '';
                currentResultsData = data;
                renderResults(data, word);
                const resultsEl = document.getElementById('results-container');
                resultsEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
        
        // --- Firebase Functions ---
        async function initializeAppAndAuth() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing. This app requires a Firebase environment.");
                showError("CRITICAL ERROR: Firebase configuration not found. The collaborative features are disabled.");
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // --- CORRECTED: Use a collaborative-friendly Firestore path ---
                musesCollection = collection(db, `artifacts/${appId}/public/data/muses`);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        listenForSharedMuses();
                    } else {
                         // --- FIXED: Use provided auth token if available ---
                        const signIn = initialAuthToken 
                            ? signInWithCustomToken(auth, initialAuthToken)
                            : signInAnonymously(auth);

                        signIn.catch(err => {
                            console.error("Authentication failed:", err);
                            showError("Could not connect to the authentication service.");
                        });
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showError(`Firebase Initialization Error: ${error.message}`);
            }
        }

        function listenForSharedMuses() {
            if (!musesCollection) return;
            const q = query(musesCollection, orderBy("createdAt", "desc"), limit(20));
            onSnapshot(q, (snapshot) => {
                const muses = [];
                snapshot.forEach(doc => {
                    muses.push({ id: doc.id, ...doc.data() });
                });
                renderSharedMuses(muses);
            }, (error) => {
                console.error("Firestore snapshot error:", error);
                showError("Could not load shared inspirations. Check Firestore rules and collection path.");
            });
        }

        function renderSharedMuses(muses) {
            if (muses.length === 0) {
                historyContainer.innerHTML = '';
                return;
            }
            let historyHtml = `
                <div class="p-4 bg-gray-800/20 rounded-lg">
                    <h2 class="text-xl font-bold text-white text-center mb-4">Shared Inspirations</h2>
                    <div class="flex flex-wrap justify-center gap-2">`;
            
            muses.forEach(muse => {
                const safeWord = muse.word.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                // Ensure muse.data exists before stringifying
                const safeData = muse.data ? JSON.stringify(muse.data).replace(/'/g, "&apos;") : '{}';
                const displayName = muse.word.length > 20 ? muse.word.substring(0, 18) + '...' : muse.word;

                historyHtml += `<button class="history-item bg-gray-700 hover:bg-gray-600 text-gray-200 text-sm font-medium px-3 py-1.5 rounded-md transition-colors" data-word="${safeWord}" data-musedata='${safeData}'><span>${displayName}</span></button>`;
            });

            historyHtml += `</div></div>`;
            historyContainer.innerHTML = historyHtml;
        }

        // --- Core Application Logic ---
        async function fetchMuseData(isFlashMode) {
            const originalWord = wordInput.value.trim();
            if (!originalWord) { 
                showError("Please enter a word."); 
                return; 
            }
           
            // --- UPDATED: Use a more recent, reliable model ---
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            renderSkeletonLoader(isFlashMode);
            generativeContainer.innerHTML = '';
            museButton.disabled = true;
            flashButton.disabled = true;
            museButton.classList.add('opacity-50', 'cursor-not-allowed');
            flashButton.classList.add('opacity-50', 'cursor-not-allowed');
            
            const focusPrompts = {
                creative: `For "tech_synonyms" and "inverse_operations", only include them if the input word has clear programming relevance. Otherwise, focus on creative and linguistic connections.`,
                technical: `Prioritize finding and detailing relevant programming commands, technical concepts, and their inverse operations.`,
                scientific: `Prioritize definitions, concepts, and terminology relevant to scientific fields like biology, chemistry, physics, and research.`,
                psychology: `Prioritize definitions, concepts, and terminology from psychology, including cognitive, behavioral, and clinical terms.`,
                legal: `Prioritize definitions, concepts, and terminology from the legal field, including civil, criminal, and contractual law.`,
                medical: `Prioritize definitions, concepts, and terminology from the medical field, including anatomy, pharmacology, and clinical practice.`
            };
            
            let combinedFocusPrompt = Array.from(activeFocuses).map(f => focusPrompts[f]).join(' ');

            let systemPrompt;
            let responseSchema;

            if (isFlashMode) {
                systemPrompt = `You are a hyper-fast thesaurus. For the given word, provide only synonyms and antonyms. Your output must be a valid JSON object. All responses MUST be in English. The JSON can optionally include a "definition" key.`;
                responseSchema = { type: "OBJECT", properties: { "definition": { "type": "STRING" }, "synonyms": { "type": "ARRAY", "items": { "type": "STRING" } }, "antonyms": { "type": "ARRAY", "items": { "type": "STRING" } } } };
            } else {
                systemPrompt = `You are "The Muse Engine," a creative and technical language tool. For the given word, provide a rich tapestry of related concepts. Your output must be a valid JSON object. Do not include any text before or after the JSON. The JSON must have keys: "definition", "synonyms", "antonyms", "related_words", "metaphors", "sensory_details", "tech_synonyms", and "inverse_operations". The "tech_synonyms" and "inverse_operations" keys should be arrays of objects, where each object has "language" and "commands" (an array of objects with "command", "explanation", and "usage_example"). If a category is not applicable, provide an empty array/string. ${combinedFocusPrompt} When multiple focuses are selected, synthesize them into a cohesive response, ensuring all keys in the JSON schema are present even if their values are empty. All responses MUST be in English.`;
                responseSchema = { type: "OBJECT", properties: { "definition": { "type": "STRING" }, "synonyms": { "type": "ARRAY", "items": { "type": "STRING" } }, "antonyms": { "type": "ARRAY", "items": { "type": "STRING" } }, "related_words": { "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "word": { "type": "STRING" }, "explanation": { "type": "STRING" } } } }, "metaphors": { "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "word": { "type": "STRING" }, "explanation": { "type": "STRING" } } } }, "sensory_details": { "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "word": { "type": "STRING" }, "explanation": { "type": "STRING" } } } }, "tech_synonyms": { "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "language": { "type": "STRING" }, "commands": { "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "command": { "type": "STRING" }, "explanation": { "type": "STRING" }, "usage_example": { "type": "STRING" } } } } } } }, "inverse_operations": { "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "language": { "type": "STRING" }, "commands": { "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "command": { "type": "STRING" }, "explanation": { "type": "STRING" }, "usage_example": { "type": "STRING" } } } } } } } } };
            }
            
            const payload = {
                contents: [{ parts: [{ text: `Generate the data for the word: "${originalWord}"` }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: { responseMimeType: "application/json", responseSchema: responseSchema }
            };
            
            try {
                const response = await fetchWithRetry(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                
                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("API Error Response:", errorBody);
                    throw new Error(`API returned status ${response.status}: ${errorBody.error?.message || 'Check console for details.'}`);
                }

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) throw new Error("The muses are quiet. Try a different word.");
                currentResultsData = JSON.parse(jsonText);
                
                if (musesCollection) {
                    try {
                        await addDoc(musesCollection, {
                            word: originalWord,
                            data: currentResultsData,
                            createdAt: serverTimestamp(),
                            userId: userId 
                        });
                    } catch (firestoreError) {
                        console.error("Error saving to Firestore:", firestoreError);
                        // Don't show this error to the user, just log it. The app can still function.
                    }
                }

                resultsContainer.innerHTML = '';
                renderResults(currentResultsData, originalWord);

            } catch (error) {
                console.error('Error fetching data:', error);
                const errorMessage = error.message.includes('JSON') ? `The muses gave an unclear answer. Let's try another word.` : (error.message || "An unexpected error occurred. Please try again.");
                resultsContainer.innerHTML = ''; 
                showError(errorMessage);
            } finally {
                clearInterval(loadingInterval);
                museButton.disabled = false;
                flashButton.disabled = false;
                museButton.classList.remove('opacity-50', 'cursor-not-allowed');
                flashButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        
        function renderSkeletonLoader(isFlashMode) {
            let skeletonHtml = `
                <div class="p-4 bg-gray-800/50 rounded-lg space-y-3">
                    <div class="h-6 w-1/3 bg-gray-700 rounded"></div>
                    <div class="flex flex-wrap gap-2">
                        <div class="h-8 w-20 bg-gray-700 rounded-md"></div> <div class="h-8 w-24 bg-gray-700 rounded-md"></div> <div class="h-8 w-16 bg-gray-700 rounded-md"></div>
                    </div>
                </div>
                <div class="p-4 bg-gray-800/50 rounded-lg space-y-3">
                    <div class="h-6 w-1/4 bg-gray-700 rounded"></div>
                    <div class="flex flex-wrap gap-2">
                        <div class="h-8 w-24 bg-gray-700 rounded-md"></div> <div class="h-8 w-16 bg-gray-700 rounded-md"></div>
                    </div>
                </div>`;
            if (!isFlashMode) {
                skeletonHtml = `<div class="h-16 bg-gray-700/50 rounded-lg"></div>` + skeletonHtml;
            }
            resultsContainer.innerHTML = `
                <div class="text-center py-10">
                    <div class="loader mx-auto"></div>
                    <p id="loading-text" class="mt-4 text-gray-400 transition-opacity duration-300"></p>
                </div>
                <div class="space-y-6 animate-pulse">${skeletonHtml}</div>`;
            
            const loadingText = document.getElementById('loading-text');
            let messageIndex = 0;
            loadingText.textContent = loadingMessages[messageIndex];
            
            loadingInterval = setInterval(() => {
                messageIndex = (messageIndex + 1) % loadingMessages.length;
                loadingText.style.opacity = '0';
                setTimeout(() => {
                    loadingText.textContent = loadingMessages[messageIndex];
                    loadingText.style.opacity = '1';
                }, 300);
            }, 2000);
        }

        function showError(message) {
            resultsContainer.innerHTML = `<div class="text-center bg-red-900/50 border border-red-700 text-red-300 px-4 py-3 rounded-lg">${message}</div>`;
        }

        function renderResults(data, originalWord) {
            if (data.definition) {
                const definitionEl = document.createElement('div');
                definitionEl.className = 'p-5 bg-gray-800/50 border border-gray-700 rounded-lg text-center';
                definitionEl.innerHTML = `<p class="text-lg text-gray-300">${data.definition}</p>`;
                resultsContainer.appendChild(definitionEl);
            }

            const sections = [
                { title: 'Synonyms', key: 'synonyms', color: 'blue', prompt: `Explain the subtle differences in connotation between these synonyms for '${originalWord}': {items}` },
                { title: 'Antonyms', key: 'antonyms', color: 'red', prompt: `For the word '${originalWord}', explain why these words are considered opposites: {items}` },
                { title: 'Related Words', key: 'related_words', color: 'purple', prompt: `Describe the conceptual connections between '${originalWord}' and these related words: {items}` },
                { title: 'Metaphors & Similes', key: 'metaphors', color: 'yellow', prompt: `Elaborate on these metaphors for '${originalWord}', perhaps providing example sentences: {items}` },
                { title: 'Sensory Details', key: 'sensory_details', color: 'pink', prompt: `Expand on how these sensory details evoke the feeling of '${originalWord}': {items}` },
            ];

            sections.forEach(sectionData => {
                const items = data[sectionData.key];
                if (Array.isArray(items) && items.length > 0) {
                    const itemsForPrompt = items.map(item => (typeof item === 'object' && item.word) ? item.word : item);
                    const section = createSection(sectionData.title, sectionData.color, itemsForPrompt, sectionData.prompt);
                    const contentDiv = section.querySelector('.section-content');
                    if (['Related Words', 'Metaphors & Similes', 'Sensory Details'].includes(sectionData.title)) {
                        contentDiv.innerHTML = `<ul class="list-disc list-inside space-y-2"></ul>`;
                        const list = contentDiv.querySelector('ul');
                        items.forEach(item => {
                            if (item && item.word) {
                                const li = document.createElement('li');
                                li.className = 'text-gray-300';
                                const card = createWordCard(item.word, item.explanation);
                                li.appendChild(card);
                                list.appendChild(li);
                            }
                        });
                    } else {
                        items.forEach(item => {
                            if (item) {
                                const card = (typeof item === 'object' && item.word) ? createWordCard(item.word, item.explanation) : createWordCard(item);
                                contentDiv.appendChild(card);
                            }
                        });
                    }
                    resultsContainer.appendChild(section);
                }
            });
            
            if (Array.isArray(data.tech_synonyms) && data.tech_synonyms.length > 0) {
                const allCommands = data.tech_synonyms.flatMap(lang => (lang.commands || []).map(c => c.command));
                const techSection = createSection("Technical Implementations", "green", allCommands, `Provide more advanced usage examples or explain common pitfalls for these commands related to '${originalWord}': {items}`);
                const contentDiv = techSection.querySelector('.section-content');
                contentDiv.className += ' space-y-4';
                renderCommands(data.tech_synonyms, contentDiv);
                resultsContainer.appendChild(techSection);
            }

            if (Array.isArray(data.inverse_operations) && data.inverse_operations.length > 0) {
                const allCommands = data.inverse_operations.flatMap(lang => (lang.commands || []).map(c => c.command));
                const inverseSection = createSection("Inverse Operations", "cyan", allCommands, `Explain scenarios where one might use these inverse operations for the concept of '${originalWord}': {items}`);
                const contentDiv = inverseSection.querySelector('.section-content');
                contentDiv.className += ' space-y-4';
                renderCommands(data.inverse_operations, contentDiv);
                resultsContainer.appendChild(inverseSection);
            }
            
            renderGenerativeButtons();
        }
        
        function renderGenerativeButtons() {
            const generativeButtonContainer = document.createElement('div');
            generativeButtonContainer.className = 'text-center mt-6 space-y-4 flex flex-wrap justify-center gap-4';

            const actions = [
                { focus: 'psychology', id: 'case-study-btn', text: '✨ Generate Case Study', handler: generateCaseStudy, classes: 'bg-teal-600 hover:bg-teal-700' },
                { focus: 'scientific', id: 'hypothesis-btn', text: '✨ Formulate Hypothesis', handler: generateHypothesis, classes: 'bg-sky-600 hover:bg-sky-700' },
                { focus: 'legal', id: 'clause-btn', text: '✨ Draft a Clause', handler: generateLegalClause, classes: 'bg-gray-600 hover:bg-gray-700' },
                { focus: 'medical', id: 'condition-btn', text: '✨ Explain Condition', handler: generateMedicalSummary, classes: 'bg-red-600 hover:bg-red-700' }
            ];

            let buttonAdded = false;
            actions.forEach(action => {
                if (activeFocuses.has(action.focus)) {
                    const btn = document.createElement('button');
                    btn.id = action.id;
                    btn.innerHTML = action.text;
                    btn.className = `${action.classes} text-white font-bold py-3 px-6 rounded-full transition-colors`;
                    btn.addEventListener('click', action.handler);
                    generativeButtonContainer.appendChild(btn);
                    buttonAdded = true;
                }
            });

            if(buttonAdded) {
                resultsContainer.appendChild(generativeButtonContainer);
            }
        }

        async function handleGenerativeRequest(btn, type, prompt, systemInstruction, color) {
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<div class="loader mx-auto" style="width:24px; height:24px; border-width:2px;"></div>`;
            generativeContainer.innerHTML = '';
            
            const titles = {
                'case-study': 'Generated Case Study',
                'hypothesis': 'Generated Hypothesis',
                'clause': 'Generated Legal Clause',
                'condition': 'Generated Medical Summary'
            };
            
            const colorMap = {
                'teal': 'border-teal-500',
                'sky': 'border-sky-500',
                'gray': 'border-gray-500',
                'red': 'border-red-500'
            };

            const responseText = await callGenerativeAPI(prompt, systemInstruction);

            if (responseText) {
                generativeContainer.innerHTML = `
                    <div class="p-5 bg-gray-800/50 border-t-2 ${colorMap[color]} rounded-lg">
                        <h2 class="text-2xl font-bold text-white text-center mb-4">${titles[type]}</h2>
                        <p class="text-gray-300 text-base leading-relaxed whitespace-pre-wrap">${responseText}</p>
                    </div>`;
            } else {
                generativeContainer.innerHTML = `<p class="text-center text-red-400">Sorry, the muses couldn't generate a response for that right now.</p>`;
            }

            btn.disabled = false;
            btn.innerHTML = originalText;
        }
        
        async function generateCaseStudy() {
            const btn = document.getElementById('case-study-btn');
            const concepts = [...new Set([...(currentResultsData.synonyms || []), ...(currentResultsData.antonyms || []), ...(currentResultsData.related_words || []).map(item => item.word)])];
            if (concepts.length === 0) {
                generativeContainer.innerHTML = `<p class="text-center text-red-400">Not enough psychological concepts found.</p>`;
                return;
            }
            const prompt = `You are a creative writer specializing in psychology. Write a brief, fictional case study (approx. 150 words) that illustrates the psychological concepts of: ${concepts.join(', ')}. The case study should be insightful and easy to understand for a layperson.`;
            const systemInstruction = "You are a helpful assistant, providing concise and clear creative writing based on the user's query about psychology.";
            await handleGenerativeRequest(btn, 'case-study', prompt, systemInstruction, 'teal');
        }

        async function generateHypothesis() {
            const btn = document.getElementById('hypothesis-btn');
            const concepts = [...new Set([wordInput.value.trim(), ...(currentResultsData.synonyms || []), ...(currentResultsData.antonyms || []), ...(currentResultsData.related_words || []).map(item => item.word)])];
            if (concepts.length === 0) {
                generativeContainer.innerHTML = `<p class="text-center text-red-400">Not enough scientific concepts found.</p>`;
                return;
            }
            const prompt = `You are a research scientist. Based on the scientific concepts of: ${concepts.join(', ')}, formulate a single, clear, and testable hypothesis. The hypothesis should be concise (approx. 50-100 words).`;
            const systemInstruction = "You are a helpful assistant acting as a research scientist, providing a clear and testable hypothesis based on the user's query.";
            await handleGenerativeRequest(btn, 'hypothesis', prompt, systemInstruction, 'sky');
        }

        async function generateLegalClause() {
            const btn = document.getElementById('clause-btn');
            const concepts = [...new Set([wordInput.value.trim(), ...(currentResultsData.synonyms || []), ...(currentResultsData.antonyms || []), ...(currentResultsData.related_words || []).map(item => item.word)])];
            if (concepts.length === 0) {
                generativeContainer.innerHTML = `<p class="text-center text-red-400">Not enough legal concepts found.</p>`;
                return;
            }
            const prompt = `You are a paralegal. Draft a short, sample legal clause for a contract that incorporates or relates to the following legal concepts: ${concepts.join(', ')}. The clause should be clear, concise, and illustrative of how these terms are used in a legal document.`;
            const systemInstruction = "You are a helpful assistant acting as a paralegal, providing a sample legal clause based on the user's query.";
            await handleGenerativeRequest(btn, 'clause', prompt, systemInstruction, 'gray');
        }
        
        async function generateMedicalSummary() {
            const btn = document.getElementById('condition-btn');
            const concepts = [...new Set([wordInput.value.trim(), ...(currentResultsData.synonyms || []), ...(currentResultsData.antonyms || []), ...(currentResultsData.related_words || []).map(item => item.word)])];
            if (concepts.length === 0) {
                generativeContainer.innerHTML = `<p class="text-center text-red-400">Not enough medical concepts found.</p>`;
                return;
            }
            const prompt = `You are a medical professional explaining a health topic to a patient. In simple, clear language (approx. 150 words), explain a potential condition related to the following terms: ${concepts.join(', ')}. Cover common symptoms and general advice. This is for informational purposes only and is not medical advice.`;
            const systemInstruction = "You are a helpful assistant acting as a medical professional, providing a simple explanation of a health condition for a layperson.";
            await handleGenerativeRequest(btn, 'condition', prompt, systemInstruction, 'red');
        }

        async function callGenerativeAPI(prompt, systemInstruction) {
             const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
             const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
            };
            try {
                const response = await fetchWithRetry(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error("Empty response from API.");
                return text;
            } catch (error) {
                console.error("Generative API Error:", error);
                return null;
            }
        }

        function renderCommands(languages, container) {
            languages.forEach(lang => {
                if (lang && lang.language && Array.isArray(lang.commands)) {
                    const langDiv = document.createElement('div');
                    langDiv.innerHTML = `<h3 class="text-xl font-bold text-gray-300 mb-2">${lang.language}</h3>`;
                    const commandsList = document.createElement('div');
                    commandsList.className = 'space-y-3';
                    lang.commands.forEach(cmd => {
                        if (cmd && cmd.command) {
                            const usageId = `usage-${Math.random().toString(36).substr(2, 9)}`;
                            const commandEl = document.createElement('div');
                            commandEl.className = 'p-3 bg-gray-900/50 rounded-md border border-gray-700';
                            commandEl.innerHTML = `
                                <div class="flex justify-between items-center">
                                    <code class="text-indigo-300 font-bold text-base cursor-pointer hover:underline" onclick="window.exploreWord('${(cmd.command || '').replace(/'/g, "\\'")}')">${cmd.command}</code>
                                    <button onclick="window.copyToClipboard('${(cmd.command || '').replace(/'/g, "\\'")}', this)" class="text-xs bg-gray-600 hover:bg-gray-500 text-gray-200 px-2 py-1 rounded">Copy</button>
                                </div>
                                <p class="text-gray-400 text-sm mt-1 mb-2">${cmd.explanation || ''}</p>
                                <div class="bg-black/30 p-2 rounded">
                                    <div class="flex justify-between items-center text-xs text-gray-400 mb-1">
                                        <span>Usage Example:</span>
                                        <button onclick="window.copyToClipboard(document.getElementById('${usageId}').innerText, this)" class="text-xs bg-gray-600 hover:bg-gray-500 text-gray-200 px-2 py-1 rounded">Copy Example</button>
                                    </div>
                                    <pre><code id="${usageId}" class="text-yellow-300 text-sm">${cmd.usage_example || ''}</code></pre>
                                </div>
                            `;
                            commandsList.appendChild(commandEl);
                        }
                    });
                    langDiv.appendChild(commandsList);
                    container.appendChild(langDiv);
                }
            });
        }
        
        // --- Utility & UI Functions ---
        window.exploreWord = function(word) {
            wordInput.value = word;
            window.scrollTo({ top: 0, behavior: 'smooth' });
            fetchMuseData(false);
        }

        function createSection(title, color, itemsForPrompt, clarificationPrompt) {
            const section = document.createElement('div');
            const borderColor = { blue: 'border-blue-500', red: 'border-red-500', purple: 'border-purple-500', yellow: 'border-yellow-500', pink: 'border-pink-500', green: 'border-green-500', cyan: 'border-cyan-400' }[color] || 'border-gray-600';
            section.className = `p-4 bg-gray-800/50 border-t-2 ${borderColor} rounded-lg`;
            section.innerHTML = `
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-white">${title}</h2>
                    <button class="clarify-btn text-sm text-gray-400 hover:text-white flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-lightbulb" viewBox="0 0 16 16"><path d="M2 6a6 6 0 1 1 10.174 4.31c-.203.196-.359.4-.453.619l-.762 1.769A.5.5 0 0 1 10.5 13a.5.5 0 0 1 0 1 .5.5 0 0 1 0 1l-.224.447a1 1 0 0 1-.894.553H6.618a1 1 0 0 1-.894-.553L5.5 15a.5.5 0 0 1 0-1 .5.5 0 0 1 0-1 .5.5 0 0 1-.46-.302l-.761-1.77a1.964 1.964 0 0 0-.453-.618A6 6 0 0 1 2 6zm6 8.5a.5.5 0 0 1 .5-.5h.5a.5.5 0 0 1 0 1h-.5a.5.5 0 0 1-.5-.5zM8 1a5 5 0 0 0-3.468 8.657c.23.235.375.56.453.922l.75 1.74a.5.5 0 0 0 .943 0l.75-1.74c.078-.362.224-.687.453-.922A5 5 0 0 0 8 1z"/></svg>
                        Clarify
                    </button>
                </div>
                <div class="mt-4 section-content flex flex-wrap gap-2"></div>
                <div class="accordion-panel bg-gray-900/50 p-4 rounded-b-lg"></div>`;
            section.querySelector('.clarify-btn').addEventListener('click', (e) => toggleClarificationPanel(e.currentTarget, clarificationPrompt, itemsForPrompt));
            return section;
        }

        function createWordCard(word, explanation = null) {
            const wordEl = document.createElement('span');
            wordEl.className = 'word-card cursor-pointer bg-gray-700 text-gray-200 text-sm font-medium px-3 py-1.5 rounded-md inline-block';
            wordEl.textContent = word;
            wordEl.onclick = () => window.exploreWord(word);
            if (explanation) {
                const container = document.createElement('div');
                container.className = 'tooltip-container';
                wordEl.classList.add('has-tooltip');
                const tooltipText = document.createElement('span');
                tooltipText.className = 'tooltip-text';
                tooltipText.textContent = explanation;
                container.appendChild(wordEl);
                container.appendChild(tooltipText);
                return container;
            }
            return wordEl;
        }

        function toggleClarificationPanel(button, promptTemplate, items) {
            const section = button.closest('.p-4');
            const panel = section.querySelector('.accordion-panel');
            if (panel.classList.contains('active')) {
                panel.classList.remove('active');
                panel.innerHTML = '';
            } else {
                const prompt = promptTemplate.replace('{items}', items.join(', '));
                panel.innerHTML = `
                    <div class="clarification-content">
                        <p class="text-sm text-gray-400 mb-2">Ask the Muse for more details:</p>
                        <textarea class="w-full bg-gray-800 border border-gray-600 rounded-md p-2 text-sm text-white focus:ring-1 focus:ring-indigo-400 outline-none" rows="3">${prompt}</textarea>
                        <div class="flex justify-end mt-2">
                             <button class="ask-muse-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md text-sm">Ask</button>
                        </div>
                        <div class="muse-response mt-4"></div>
                    </div>`;
                panel.classList.add('active');
                panel.querySelector('.ask-muse-btn').addEventListener('click', (e) => fetchClarification(e.currentTarget));
            }
        }
        
        async function fetchClarification(button) {
            const contentDiv = button.closest('.clarification-content');
            const textarea = contentDiv.querySelector('textarea');
            const responseDiv = contentDiv.querySelector('.muse-response');
            const userQuery = textarea.value;

            button.disabled = true;
            button.textContent = 'Thinking...';
            responseDiv.innerHTML = '<div class="loader mx-auto" style="width:24px; height:24px; border-width:2px;"></div>';
            
            const responseText = await callGenerativeAPI(userQuery, "You are a helpful assistant, providing concise and clear explanations based on the user's query about language and code.");

            if(responseText) {
                responseDiv.innerHTML = `<p class="text-gray-300 text-sm leading-relaxed">${responseText.replace(/\n/g, '<br>')}</p>`;
            } else {
                 responseDiv.innerHTML = `<p class="text-red-400 text-sm">Sorry, I couldn't get a clarification on that.</p>`;
            }
            
            button.disabled = false;
            button.textContent = 'Ask';
        }
        
        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 || response.status >= 500) {
                        // Only retry on rate limiting or server errors
                        if (i === retries - 1) throw new Error(`Request failed after ${retries} attempts.`);
                        await new Promise(res => setTimeout(res, delay * Math.pow(2, i))); // Exponential backoff
                        continue;
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                }
            }
        }

        window.copyToClipboard = function(text, button) {
            if (!text) return;
            const tempInput = document.createElement('textarea');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);

            const originalText = button.textContent;
            button.textContent = 'Copied!';
            copyNotification.classList.remove('opacity-0', 'translate-y-2');

            setTimeout(() => {
                button.textContent = originalText;
                copyNotification.classList.add('opacity-0', 'translate-y-2');
            }, 2000);
        }
    </script>
</body>
</html>


